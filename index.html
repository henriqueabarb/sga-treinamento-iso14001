<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SGA - Gest√£o de Treinamentos</title>

    <!-- Tailwind via CDN (biblioteca de CSS pronta) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Chart.js para gr√°fico de rosca (doughnut) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Fonte Inter (deixa o visual mais moderno) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Estilo b√°sico da p√°gina (cor de fundo, fonte, etc.) */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        /* Classe das abas (tabs) do menu Gestor / Funcion√°rio */
        .nav-tab {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            font-weight: 500;
            color: #6B7280; 
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }

        /* Aba ativa fica com a cor azul e borda embaixo */
        .nav-tab.active-tab {
            color: #1E40AF; 
            border-bottom-color: #1E40AF;
        }

        /* Anima√ß√£o de entrada das p√°ginas (fica mais suave) */
        .page-content {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Container do gr√°fico de rosca */
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 350px;
        }

        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
            }
        }

        /* Classe gen√©rica para modais (caixas que aparecem por cima da tela) */
        .modal {
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 50;
        }

        /* Pontinhos de status na tabela (cores) */
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .bg-status-em_dia { background-color: #10B981; }  /* Verde */
        .text-status-em_dia { color: #059669; }
        .bg-status-atencao { background-color: #F59E0B; } /* Amarelo */
        .text-status-atencao { color: #D97706; }
        .bg-status-vencido { background-color: #EF4444; } /* Vermelho */
        .text-status-vencido { color: #DC2626; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- ============================== -->
    <!-- TELA DE LOGIN                  -->
    <!-- ============================== -->

    <!-- Essa div √© a tela inicial onde o usu√°rio digita a matr√≠cula -->
    <div id="login-screen" class="max-w-md mx-auto bg-white p-8 rounded-xl shadow-2xl mt-12">
        <h1 class="text-2xl font-bold text-blue-800 mb-4 text-center">Login SGA</h1>
        <p class="text-gray-600 mb-6 text-center">Insira sua matr√≠cula para acessar o painel de compet√™ncia.</p>

        <!-- Campo de texto onde o usu√°rio digita a matr√≠cula -->
        <input 
            type="text" 
            id="matricula-input" 
            placeholder="Ex: 12345 (Funcion√°rio) ou GESTOR" 
            class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-blue-800 focus:border-blue-800"
        >

        <!-- Bot√£o para fazer login -->
        <button 
            id="login-button" 
            class="w-full bg-blue-700 text-white p-3 rounded-lg font-semibold hover:bg-blue-800 transition-colors">
            Acessar Sistema
        </button>

        <p class="mt-4 text-sm text-gray-500 text-center">Use 'GESTOR' para o painel de indicadores.</p>
    </div>

    <!-- ============================== -->
    <!-- CONTAINER PRINCIPAL DA APLICA√á√ÉO -->
    <!-- ============================== -->

    <!-- Essa div √© o sistema em si (dashboard). Ela come√ßa escondida (class="hidden") -->
    <div id="app-container" class="hidden">
        <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        
            <!-- Cabe√ßalho do sistema -->
            <header class="mb-6 flex justify-between items-start gap-4">
                <!-- Lado esquerdo: t√≠tulo e descri√ß√£o -->
                <div>
                    <h1 class="text-3xl font-bold text-blue-800">
                        SGA: Gest√£o de Treinamentos (ISO 14001)
                    </h1>
                    <p class="text-lg text-gray-600 mt-1">
                        Plataforma interativa para registro e conformidade de treinamentos ambientais (Goi√°s).
                    </p>

                    <!-- Aqui aparece a matr√≠cula atual do usu√°rio logado -->
                    <p id="userIdDisplay" class="mt-1 text-sm text-gray-600">
                        Matr√≠cula Atual: N/A
                    </p>
                </div>

                <!-- Lado direito: bot√£o para voltar para a tela de login -->
                <!-- Esse bot√£o faz um "logout" simples, limpando a matr√≠cula e voltando ao login -->
                <button
                    id="logout-button"
                    class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg text-sm font-medium shadow-sm hover:bg-gray-300 transition-colors">
                    ‚Üê Voltar para Login
                </button>
            </header>

            <!-- Navega√ß√£o por abas: Gestor / Funcion√°rio -->
            <nav class="flex border-b border-gray-300 mb-6">
                <button id="tab-gestor" class="nav-tab active-tab">Painel do Gestor</button>
                <button id="tab-funcionario" class="nav-tab">Painel do Funcion√°rio</button>
            </nav>

            <main>
                <!-- ============================== -->
                <!-- PAINEL DO GESTOR               -->
                <!-- ============================== -->
                <div id="content-gestor" class="page-content">
                    <section id="gestor-dashboard">
                        <h2 class="text-2xl font-semibold text-gray-700 mb-4">Dashboard de Conformidade</h2>
                        <p class="text-gray-600 mb-6">
                            Esta se√ß√£o mostra um resumo da situa√ß√£o dos treinamentos da equipe.
                            O gr√°fico de rosca resume Em Dia, Aten√ß√£o e Vencido, e a tabela mostra os detalhes por funcion√°rio.
                        </p>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <!-- Card com o gr√°fico de rosca -->
                            <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
                                <h3 class="text-lg font-semibold text-center mb-4">Status Geral de Conformidade</h3>
                                <div class="chart-container">
                                    <canvas id="complianceChart"></canvas>
                                </div>
                            </div>
                            
                            <!-- Cards com n√∫meros (estat√≠sticas) -->
                            <div class="space-y-4">
                                <!-- Registros vencidos -->
                                <div class="bg-white p-6 rounded-lg shadow-md flex items-center space-x-4">
                                    <div class="p-3 rounded-full bg-status-vencido bg-opacity-20">
                                        <span class="text-2xl text-status-vencido">‚ö†Ô∏è</span>
                                    </div>
                                    <div>
                                        <div id="stat-vencido" class="text-3xl font-bold text-status-vencido">0</div>
                                        <div class="text-sm font-medium text-gray-500">Registros Vencidos</div>
                                    </div>
                                </div>

                                <!-- Registros que vencem em 30 dias -->
                                <div class="bg-white p-6 rounded-lg shadow-md flex items-center space-x-4">
                                    <div class="p-3 rounded-full bg-status-atencao bg-opacity-20">
                                        <span class="text-2xl text-status-atencao">üîî</span>
                                    </div>
                                    <div>
                                        <div id="stat-atencao" class="text-3xl font-bold text-status-atencao">0</div>
                                        <div class="text-sm font-medium text-gray-500">Vence em 30 dias</div>
                                    </div>
                                </div>

                                <!-- Registros em dia -->
                                <div class="bg-white p-6 rounded-lg shadow-md flex items-center space-x-4">
                                    <div class="p-3 rounded-full bg-status-em_dia bg-opacity-20">
                                        <span class="text-2xl text-status-em_dia">‚úÖ</span>
                                    </div>
                                    <div>
                                        <div id="stat-em_dia" class="text-3xl font-bold text-status-em_dia">0</div>
                                        <div class="text-sm font-medium text-gray-500">Registros em Dia</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Tabela com todos os registros da equipe -->
                    <section id="gestor-tabela" class="mt-8">
                        <h2 class="text-2xl font-semibold text-gray-700 mb-4">
                            Rastreabilidade da Equipe (Registros)
                        </h2>

                        <!-- Mensagem enquanto carrega dados -->
                        <div id="loading-gestor" class="text-center text-gray-500 my-8">
                            Carregando rastreabilidade da equipe...
                        </div>

                        <!-- Tabela de registros -->
                        <div class="bg-white rounded-lg shadow-md overflow-hidden">
                            <div class="overflow-x-auto">
                                <table class="w-full min-w-[600px]">
                                    <thead class="bg-gray-100">
                                        <tr>
                                            <th class="p-4 text-left text-sm font-semibold text-gray-600">Matr√≠cula</th>
                                            <th class="p-4 text-left text-sm font-semibold text-gray-600">Treinamento</th>
                                            <th class="p-4 text-left text-sm font-semibold text-gray-600">Conclus√£o</th>
                                            <th class="p-4 text-left text-sm font-semibold text-gray-600">Validade</th>
                                            <th class="p-4 text-center text-sm font-semibold text-gray-600">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="gestor-table-body" class="divide-y divide-gray-200">
                                        <!-- Linhas s√£o preenchidas via JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Bot√£o que abre modal de "Gerenciar Treinamentos" (simula√ß√£o) -->
                        <button 
                            id="open-manage-modal-btn" 
                            class="mt-6 bg-blue-700 text-white font-medium py-2 px-5 rounded-lg shadow-md hover:bg-blue-800 transition-colors">
                            Gerenciar Treinamentos (Simulado)
                        </button>
                    </section>
                </div>

                <!-- ============================== -->
                <!-- PAINEL DO FUNCION√ÅRIO          -->
                <!-- ============================== -->
                <div id="content-funcionario" class="page-content hidden">
                    <section id="funcionario-treinamentos">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-semibold text-gray-700">
                                Meus Treinamentos Obrigat√≥rios
                            </h2>
                        </div>

                        <p class="text-gray-600 mb-6">
                            Aqui aparecem os treinamentos ambientais obrigat√≥rios.
                            O funcion√°rio pode confirmar a conclus√£o para registrar a conformidade.
                        </p>
                        
                        <!-- Mensagem enquanto carrega os dados -->
                        <div id="loading-funcionario" class="text-center text-gray-500 my-8">
                            Carregando dados de conformidade...
                        </div>

                        <!-- Lista de cards de treinamentos (preenchida no JS) -->
                        <div id="training-list" class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
                        </div>
                    </section>
                </div>
            </main>
        </div>
    </div>
    
    <!-- ============================== -->
    <!-- MODAIS                         -->
    <!-- ============================== -->

    <!-- Modal gen√©rico para mostrar mensagens (sucesso/erro) -->
    <div id="message-modal" class="hidden modal">
        <div class="relative mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 id="modal-title" class="text-lg leading-6 font-medium text-gray-900">
                    Mensagem do Sistema
                </h3>
                <div class="mt-2 px-7 py-3">
                    <p id="modal-body" class="text-sm text-gray-500">...</p>
                </div>
                <div class="items-center px-4 py-3">
                    <button 
                        id="modal-close-button" 
                        class="px-4 py-2 bg-blue-700 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-800">
                        Fechar
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal de "Assistir" treinamento (simula um player de v√≠deo) -->
    <div id="video-modal" class="modal hidden">
        <div class="bg-white w-full max-w-lg p-6 rounded-lg shadow-xl m-4">
            <div class="flex justify-between items-center mb-4">
                <h3 id="video-modal-title" class="text-xl font-semibold">T√≠tulo do Treinamento</h3>
                <button id="close-video-modal-btn" class="text-gray-500 hover:text-gray-800">&times;</button>
            </div>

            <!-- Aqui seria o v√≠deo de fato, mas no projeto √© s√≥ simula√ß√£o -->
            <div class="bg-gray-900 text-white h-64 flex items-center justify-center rounded-lg mb-4">
                <p>(Simula√ß√£o de Player de V√≠deo)</p>
            </div>

            <p id="video-modal-desc" class="text-gray-600 mb-6">
                Descri√ß√£o do treinamento e sua import√¢ncia para a legisla√ß√£o de Goi√°s.
            </p>

            <!-- Bot√£o para confirmar que concluiu o treinamento -->
            <button 
                id="confirm-completion-btn" 
                class="w-full bg-green-600 text-white font-medium py-3 px-5 rounded-lg shadow-md hover:bg-green-700 transition-colors">
                Confirmar Conclus√£o
            </button>
        </div>
    </div>

    <!-- Modal de "Gerenciar" treinamentos (apenas visual, sem backend real) -->
    <div id="manage-modal" class="modal hidden">
        <div class="bg-white w-full max-w-2xl p-6 rounded-lg shadow-xl m-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Gerenciar Treinamentos</h3>
                <button id="close-manage-modal-btn" class="text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            
            <h4 class="text-lg font-semibold text-gray-700 mb-2">
                Adicionar Novo Treinamento (Simula√ß√£o visual)
            </h4>
            <div class="p-4 border rounded-lg mb-6 bg-gray-50 text-gray-600">
                <p>
                    O cadastro de novos treinamentos √© uma fun√ß√£o do Backend (Java/Spring Boot).
                    Esta tela √© s√≥ para mostrar no relat√≥rio (n√£o grava nada de verdade).
                </p>
            </div>

            <h4 class="text-lg font-semibold text-gray-700 mb-2">
                Treinamentos Existentes (Hardcoded)
            </h4>
            <div id="manage-list" class="space-y-2">
                <!-- A lista √© preenchida via JavaScript com base no array TREINAMENTOS -->
            </div>
        </div>
    </div>


    <!-- ============================== -->
    <!-- SCRIPT PRINCIPAL + FIREBASE    -->
    <!-- ============================== -->
    <script type="module">
        /* 
          Aqui come√ßa a parte de JavaScript.
          √â onde fazemos:
          - Conex√£o com Firebase
          - Login an√¥nimo
          - Leitura/grava√ß√£o no Firestore
          - Renderiza√ß√£o din√¢mica da tela
        */

        // Import das fun√ß√µes do Firebase (vers√£o modular)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, setDoc, onSnapshot, collection, query, where, 
            serverTimestamp, setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURA√á√ÉO REAL DO FIREBASE ---
        // Esses dados s√£o pegos do Console do Firebase (Configura√ß√£o do app web)
        const firebaseConfig = {
          apiKey: "AIzaSyBVyqEhlJsxuLeQrtjZRS538JZf28Pqtbk",
          authDomain: "sga-treinamento-goias.firebaseapp.com",
          projectId: "sga-treinamento-goias",
          storageBucket: "sga-treinamento-goias.firebasestorage.app",
          messagingSenderId: "1072216886470",
          appId: "1:1072216886470:web:0788e8f46a234189c19bc7"
        };

        // S√≥ um exemplo de uso de vari√°vel de ambiente / identifica√ß√£o
        const appId = firebaseConfig.projectId; 
        const initialAuthToken = null; // n√£o est√° sendo usado aqui

        // Vari√°veis globais de estado (para guardar objetos do Firebase e info do usu√°rio)
        let app, db, auth, userId;
        let currentMatricula = localStorage.getItem('currentMatricula') || null;

        // Log do Firestore em modo "Debug" (ajuda a enxergar problemas no console)
        setLogLevel('Debug'); 
        
        // Quantos dias antes da validade o sistema considera "Aten√ß√£o"
        const ATTENTION_DAYS = 30;

        // Inst√¢ncia do gr√°fico de rosca (para poder destruir e recriar quando atualizar)
        let complianceChartInstance = null;
        
        // --- DADOS MOCK (Cat√°logo de Treinamentos, simulando Backend Java) ---
        // Esse array representa a "tabela" de tipos de treinamentos que existem na empresa
        const TREINAMENTOS = [
            { id: 'T101', titulo: 'Aspectos e Impactos Ambientais (ISO 14001)', periodicidade: 365, publico_alvo: "todos", relevancia_goias: 'ISO, Legal' },
            { id: 'T102', titulo: 'Gerenciamento de Res√≠duos S√≥lidos', periodicidade: 180, publico_alvo: "operacao", relevancia_goias: 'Legal, Operacional (Goi√°s)' },
            { id: 'T103', titulo: 'Uso Racional da √Ågua', periodicidade: 540, publico_alvo: "todos", relevancia_goias: 'ISO, Operacional' },
            { id: 'T104', titulo: 'Legisla√ß√£o do ICMS Ecol√≥gico (Goi√°s)', periodicidade: 730, publico_alvo: "todos", relevancia_goias: 'Legal, Administrativo' },
        ];
        
        // =====================================================
        // FUN√á√ïES DE L√ìGICA DE NEG√ìCIO (CONFORMIDADE)
        // =====================================================

        /**
         * Calcula o status do treinamento com base na data de validade.
         * - Se j√° passou da validade: "Vencido"
         * - Se est√° dentro dos pr√≥ximos ATTENTION_DAYS dias: "Aten√ß√£o"
         * - Sen√£o: "Em Dia"
         */
        function calcularStatus(dataValidade) {
            if (!dataValidade || isNaN(new Date(dataValidade))) return 'Pendente'; 

            const hoje = new Date();
            const validade = new Date(dataValidade);
            const diffTime = validade.getTime() - hoje.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays <= 0) return 'Vencido';
            if (diffDays <= ATTENTION_DAYS) return 'Aten√ß√£o';
            return 'Em Dia';
        }

        /**
         * Retorna a cole√ß√£o do Firestore onde os registros de conformidade s√£o salvos.
         * A estrutura usa um path "artifacts/{appId}/public/data/registros_conformidade".
         */
        function getRegistrosCollection() {
            return collection(db, `/artifacts/${appId}/public/data/registros_conformidade`);
        }

        // =====================================================
        // FUN√á√ïES DE PERSIST√äNCIA (GRAVAR NO FIRESTORE)
        // =====================================================

        /**
         * Registra a conclus√£o de um treinamento para uma matr√≠cula.
         * - Calcula nova data de validade usando a periodicidade (dias).
         * - Usa setDoc com docId √∫nico (matricula + treinamentoId).
         */
        async function registrarConclusao(matricula, treinamentoId) {
            if (!db) throw new Error("Conex√£o com o Firebase n√£o estabelecida.");
            
            const treinamento = TREINAMENTOS.find(t => t.id === treinamentoId);
            if (!treinamento) throw new Error("Treinamento n√£o encontrado no cat√°logo.");

            const dataConclusao = new Date();
            const validadeMillis = treinamento.periodicidade * 24 * 60 * 60 * 1000;
            const dataValidade = new Date(dataConclusao.getTime() + validadeMillis);
            
            const docId = `${matricula}_${treinamentoId}`; 

            const novoRegistro = {
                matricula: matricula,
                treinamentoId: treinamentoId,
                dataConclusao: serverTimestamp(),   // serverTimestamp para garantir hor√°rio do servidor
                dataValidade: dataValidade.toISOString(),
                periodicidadeDias: treinamento.periodicidade,
            };

            try {
                // Upsert: se j√° tiver documento com esse id, ele substitui; se n√£o tiver, cria
                const docRef = doc(getRegistrosCollection(), docId);
                await setDoc(docRef, novoRegistro);
                return `Conclus√£o registrada com sucesso! Pr√≥xima validade: ${new Date(dataValidade).toLocaleDateString('pt-BR')}.`;
            } catch (error) {
                console.error("Erro ao registrar conclus√£o no Firestore:", error);
                throw new Error("Falha ao salvar o registro. Verifique as Regras de Seguran√ßa do Firebase. Erro: " + error.code);
            }
        }
        
        // =====================================================
        // FUN√á√ïES DE INTERFACE (RENDERIZA√á√ÉO NA TELA)
        // =====================================================

        /**
         * Exibe o modal de mensagem com t√≠tulo e texto.
         */
        function showModal(title, body) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-body').innerHTML = body;
            document.getElementById('message-modal').classList.remove('hidden');
        }

        /**
         * Renderiza os cards do painel do funcion√°rio.
         * Cada card representa um treinamento obrigat√≥rio.
         */
        function renderFuncionarioPanel(registros) {
            const container = document.getElementById('training-list');
            container.innerHTML = '';
            document.getElementById('loading-funcionario').classList.add('hidden');
            
            // Mapeia os registros por ID de treinamento (para achar mais f√°cil depois)
            const dataMap = registros.reduce((acc, reg) => {
                acc[reg.treinamentoId] = reg;
                return acc;
            }, {});

            // Para cada treinamento do cat√°logo, verifica o status
            TREINAMENTOS.forEach(treinamento => {
                const registro = dataMap[treinamento.id] || null;
                const dataValidade = registro ? new Date(registro.dataValidade) : null;
                const status = calcularStatus(dataValidade);

                let colorClass, statusText, actionEnabled;
                if (status === 'Em Dia') { 
                    colorClass = 'bg-status-em_dia'; 
                    statusText = `V√°lido at√©: ${dataValidade.toLocaleDateString('pt-BR')}`; 
                    actionEnabled = false; 
                } else if (status === 'Aten√ß√£o') { 
                    colorClass = 'bg-status-atencao'; 
                    statusText = `ATEN√á√ÉO! Vence em: ${dataValidade.toLocaleDateString('pt-BR')}`; 
                    actionEnabled = true; 
                } else if (status === 'Vencido') { 
                    colorClass = 'bg-status-vencido'; 
                    statusText = `VENCIDO desde: ${dataValidade.toLocaleDateString('pt-BR')}`; 
                    actionEnabled = true; 
                } else { 
                    colorClass = 'bg-status-vencido'; 
                    statusText = 'Pendente de Conclus√£o'; 
                    actionEnabled = true; 
                }
                
                const validadeText = dataValidade ? dataValidade.toLocaleDateString('pt-BR') : 'N/A';

                // HTML do card
                const card = `
                    <div class="card p-5 bg-white rounded-xl shadow-lg border-l-4 ${colorClass.replace('bg-', 'border-')}">
                        <h4 class="text-lg font-semibold text-gray-800 mb-2">${treinamento.titulo}</h4>
                        <p class="text-sm text-gray-600">Periodicidade: ${treinamento.periodicidade} dias</p>
                        <p class="text-sm text-gray-600">Relev√¢ncia: ${treinamento.relevancia_goias}</p>
                        <p class="text-sm font-semibold mt-2 text-gray-700">Validade: ${validadeText}</p>
                        <span class="inline-block px-3 py-1 mt-2 text-xs font-semibold text-white rounded-full ${colorClass}">${statusText}</span>
                        ${actionEnabled ? `
                            <button data-treinamento-id="${treinamento.id}" 
                                    class="btn-concluir w-full mt-4 bg-blue-700 text-white p-2 rounded-lg text-sm font-medium hover:bg-blue-800 transition-colors">
                                Confirmar Conclus√£o
                            </button>
                        ` : `
                            <button disabled class="w-full mt-4 bg-gray-300 text-gray-600 p-2 rounded-lg text-sm font-medium">
                                Em Dia
                            </button>
                        `}
                    </div>
                `;
                container.innerHTML += card;
            });

            // Adiciona eventos nos bot√µes "Confirmar Conclus√£o"
            document.querySelectorAll('.btn-concluir').forEach(button => {
                button.onclick = async (e) => {
                    const id = e.target.getAttribute('data-treinamento-id');
                    e.target.disabled = true;
                    e.target.textContent = 'Registrando...';
                    try {
                        const message = await registrarConclusao(currentMatricula, id);
                        showModal("Registro de Conclus√£o", message);
                    } catch (error) {
                        showModal("Erro no Registro", error.message);
                    } finally {
                        e.target.disabled = false;
                        e.target.textContent = 'Confirmar Conclus√£o';
                    }
                };
            });
        }

        /**
         * Renderiza a tabela e os indicadores do painel do gestor.
         * Recebe todos os registros de todos os funcion√°rios.
         */
        function renderGestorPanel(todosRegistros) {
            const tableBody = document.getElementById('gestor-table-body');
            tableBody.innerHTML = '';
            document.getElementById('loading-gestor').classList.add('hidden');

            const statusCounts = { 'Em Dia': 0, 'Aten√ß√£o': 0, 'Vencido': 0, 'Pendente': 0 };
            
            todosRegistros.forEach(reg => {
                const dataValidade = new Date(reg.dataValidade);
                const status = calcularStatus(dataValidade);
                
                // Soma a quantidade por status
                if (statusCounts.hasOwnProperty(status)) {
                    statusCounts[status]++;
                }

                // Define cor da "pill" de status na tabela
                let colorClass;
                if (status === 'Em Dia') { 
                    colorClass = 'bg-status-em_dia'; 
                } else if (status === 'Aten√ß√£o') { 
                    colorClass = 'bg-status-atencao'; 
                } else if (status === 'Vencido' || status === 'Pendente') { 
                    colorClass = 'bg-status-vencido'; 
                } else { 
                    colorClass = 'bg-status-atencao'; 
                }
                
                const treinamento = TREINAMENTOS.find(t => t.id === reg.treinamentoId)?.titulo || 'Desconhecido';
                
                let dataConcText = reg.dataConclusao?.toDate ? reg.dataConclusao.toDate().toLocaleDateString('pt-BR') : 'N/A';
                
                const row = `
                    <tr>
                        <td class="p-4 text-gray-600">${reg.matricula}</td>
                        <td class="p-4 text-gray-600">${treinamento}</td>
                        <td class="p-4 text-gray-600">${dataConcText}</td>
                        <td class="p-4 text-gray-600">${dataValidade.toLocaleDateString('pt-BR')}</td>
                        <td class="p-4 text-center">
                            <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full text-white ${colorClass}">
                                ${status}
                            </span>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
            
            // Atualiza os cards de indicadores
            document.getElementById('stat-em_dia').textContent = statusCounts['Em Dia'];
            document.getElementById('stat-atencao').textContent = statusCounts['Aten√ß√£o'];
            document.getElementById('stat-vencido').textContent = statusCounts['Vencido'] + statusCounts['Pendente'];

            // Atualiza o gr√°fico de rosca
            renderComplianceChart(statusCounts);
        }

        /**
         * Cria ou recria o gr√°fico de rosca de conformidade.
         */
        function renderComplianceChart(stats) {
            const ctx = document.getElementById('complianceChart').getContext('2d');
            
            // Se j√° existir um gr√°fico, destr√≥i antes de criar outro (para n√£o bugar)
            if (complianceChartInstance) {
                complianceChartInstance.destroy();
            }

            complianceChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Em Dia', 'Vence em 30 dias', 'Risco/Vencido'],
                    datasets: [{
                        data: [
                            stats['Em Dia'], 
                            stats['Aten√ß√£o'], 
                            stats['Vencido'] + stats['Pendente']
                        ],
                        backgroundColor: ['#10B981', '#F59E0B', '#EF4444'],
                        borderColor: '#FFFFFF',
                        borderWidth: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: { size: 14, family: 'Inter' }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) { label += ': '; }
                                    if (context.parsed !== null) { label += context.parsed; }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // =====================================================
        // INICIALIZA√á√ÉO DO FIREBASE E LOGIN
        // =====================================================

        /**
         * Inicializa o Firebase e faz login an√¥nimo.
         * Depois, fica escutando mudan√ßas de autentica√ß√£o.
         */
        async function initializeFirebase() {
            try {
                if (!firebaseConfig.apiKey) {
                    showModal("Erro Cr√≠tico", "As chaves do Firebase n√£o foram configuradas. O sistema n√£o pode iniciar.");
                    document.getElementById('login-screen').classList.remove('hidden');
                    return;
                }

                // Inicializa o app e os servi√ßos de Firestore e Auth
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Faz login an√¥nimo (n√£o pede email/senha)
                await signInAnonymously(auth);

                // Observa se o usu√°rio autenticado muda
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Usu√°rio Firebase autenticado:", userId);

                        // Se j√° tinha uma matr√≠cula salva no localStorage, tenta retomar a sess√£o
                        if (currentMatricula) {
                            handleLogin(currentMatricula, true);
                        } else {
                            document.getElementById('login-screen').classList.remove('hidden');
                        }
                    } else {
                        console.log("Falha na autentica√ß√£o ou sess√£o encerrada.");
                        document.getElementById('login-screen').classList.remove('hidden');
                    }
                });

            } catch (error) {
                console.error("Erro na inicializa√ß√£o ou autentica√ß√£o do Firebase:", error);
                showModal("Erro Cr√≠tico", `Falha ao iniciar a conex√£o com o Firebase. Detalhes: ${error.message}.`);
                document.getElementById('login-screen').classList.remove('hidden');
            }
        }

        /**
         * Faz o fluxo de login da matr√≠cula.
         * - Salva matr√≠cula no localStorage
         * - Esconde tela de login
         * - Mostra app
         * - Decide se √© gestor ou funcion√°rio
         */
        function handleLogin(matricula, isSessionResume = false) {
            matricula = matricula.toUpperCase().trim();
            if (!matricula) {
                showModal("Erro de Login", "Por favor, insira sua matr√≠cula.");
                return;
            }

            currentMatricula = matricula;
            localStorage.setItem('currentMatricula', currentMatricula);
            
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            document.getElementById('userIdDisplay').textContent = `Matr√≠cula: ${currentMatricula}`;

            // Se n√£o for recome√ßo de sess√£o, configura o listener do Firestore
            if (!isSessionResume) {
                setupFirestoreListeners(currentMatricula === 'GESTOR' ? 'gestor' : 'funcionario');
            }
            
            // Mostra painel correto com base na matr√≠cula
            showPanel(currentMatricula === 'GESTOR' ? 'gestor' : 'funcionario');
        }
        
        /**
         * Configura os listeners em tempo real (onSnapshot) no Firestore.
         * - Se for funcion√°rio, escuta s√≥ os registros daquela matr√≠cula.
         * - Se for gestor, escuta todos os registros.
         */
        function setupFirestoreListeners(panel) {
            if (!db || !userId) return;

            if (panel === 'funcionario') {
                const q = query(getRegistrosCollection(), where("matricula", "==", currentMatricula));
                onSnapshot(q, (snapshot) => {
                    document.getElementById('loading-funcionario').classList.add('hidden');
                    const registros = snapshot.docs.map(doc => doc.data());
                    renderFuncionarioPanel(registros);
                }, (error) => {
                    console.error("Erro no listener do Funcion√°rio:", error);
                    showModal("Erro de Conex√£o", "N√£o foi poss√≠vel carregar seus registros de treinamento.");
                });
            } else if (panel === 'gestor') {
                const q = query(getRegistrosCollection());
                onSnapshot(q, (snapshot) => {
                    document.getElementById('loading-gestor').classList.add('hidden');
                    const todosRegistros = snapshot.docs.map(doc => doc.data());
                    renderGestorPanel(todosRegistros);
                }, (error) => {
                    console.error("Erro no listener do Gestor:", error);
                    showModal("Erro de Conex√£o", "N√£o foi poss√≠vel carregar os indicadores da equipe.");
                });
            }
        }

        /**
         * Alterna entre os pain√©is Gestor e Funcion√°rio.
         * Tamb√©m garante que s√≥ GESTOR consiga ver o painel do gestor.
         */
        function showPanel(panel) {
            const isGestor = panel === 'gestor';
            
            // Se tentar ir para o painel do Gestor sem ser GESTOR, barra
            if (isGestor && currentMatricula !== 'GESTOR') {
                showModal("Acesso Negado", "Voc√™ n√£o tem permiss√£o para acessar o Painel do Gestor.");
                if (currentMatricula) {
                    showPanel('funcionario'); 
                } else {
                    document.getElementById('login-screen').classList.remove('hidden');
                }
                return;
            }
            
            // Mostra/Esconde o conte√∫do correspondente
            document.getElementById('content-gestor').classList.toggle('hidden', !isGestor);
            document.getElementById('content-funcionario').classList.toggle('hidden', isGestor);
            
            // Atualiza visual das abas
            document.getElementById('tab-gestor').classList.toggle('active-tab', isGestor);
            document.getElementById('tab-funcionario').classList.toggle('active-tab', !isGestor);
            
            // Garante que o listener certo esteja ativo
            setupFirestoreListeners(panel); 
        }

        // =====================================================
        // EVENTOS GERAIS DA P√ÅGINA (DOM)
        // =====================================================

        document.addEventListener('DOMContentLoaded', () => {
            // Inicializa Firebase e faz login an√¥nimo
            initializeFirebase(); 
            
            // Clique no bot√£o de login
            document.getElementById('login-button').addEventListener('click', () => {
                const matricula = document.getElementById('matricula-input').value;
                handleLogin(matricula); 
            });

            // Permite dar Enter no campo de matr√≠cula para logar
            document.getElementById('matricula-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('login-button').click();
                }
            });

            // Troca para aba do Gestor
            document.getElementById('tab-gestor').addEventListener('click', () => showPanel('gestor'));

            // Troca para aba do Funcion√°rio
            document.getElementById('tab-funcionario').addEventListener('click', () => showPanel('funcionario'));

            // Fecha o modal de mensagem gen√©rica
            document.getElementById('modal-close-button').addEventListener('click', () => {
                document.getElementById('message-modal').classList.add('hidden');
            });

            // Bot√£o "Voltar para Login" (logout simples)
            document.getElementById('logout-button').addEventListener('click', () => {
                // limpa matr√≠cula atual e o localStorage
                currentMatricula = null;
                localStorage.removeItem('currentMatricula');

                // limpa o input da matr√≠cula
                const input = document.getElementById('matricula-input');
                if (input) input.value = '';

                // esconde o app e mostra a tela de login
                document.getElementById('app-container').classList.add('hidden');
                document.getElementById('login-screen').classList.remove('hidden');
            });

            // Abrir modal de "Gerenciar Treinamentos" (simula√ß√£o)
            document.getElementById('open-manage-modal-btn').addEventListener('click', () => {
                const listContainer = document.getElementById('manage-list');
                listContainer.innerHTML = '';
                TREINAMENTOS.forEach(t => {
                    listContainer.innerHTML += `
                        <div class="flex justify-between items-center p-3 bg-gray-100 rounded">
                            <div>
                                <span class="font-medium">${t.titulo}</span>
                                <span class="text-sm text-gray-500 ml-2">(${t.periodicidade} dias)</span>
                            </div>
                        </div>
                    `;
                });
                document.getElementById('manage-modal').classList.remove('hidden');
            });

            // Fechar modal de "Gerenciar Treinamentos"
            document.getElementById('close-manage-modal-btn').addEventListener('click', () => {
                document.getElementById('manage-modal').classList.add('hidden');
            });

            // (Opcional) Aqui poderiam entrar eventos do video-modal, se voc√™ quiser usar ele depois
            // document.getElementById('close-video-modal-btn')...
        });
    </script>

</body>
</html>
